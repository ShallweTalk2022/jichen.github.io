<!DOCTYPE html>
<html lang="zh-Hans">
<head>

<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/>

  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Zhi Mang Xing:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":false,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Race Condition 数字电路中的竞争与冒险 竞争： 竞争（Competition）定义为：在组合逻辑电路中，某个输入变量通过两条或两条以上的途径传到输出端，由于每条途径的延迟时间不同，到达输出门的时间就有先有后，这种现象称为竞争。把不会产生错误输出的竞争的现象称为非临界竞争。把产生暂时性的或永久性错误输出的竞争现象称为临界竞争 一个竞争的例子如图所示。图中的输入信号经过了两个不同">
<meta property="og:type" content="article">
<meta property="og:title" content="Race Condition">
<meta property="og:url" content="http://example.com/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.3.1%20Race%20Conditions/index.html">
<meta property="og:site_name" content="寄尘&#39;s Blog">
<meta property="og:description" content="Race Condition 数字电路中的竞争与冒险 竞争： 竞争（Competition）定义为：在组合逻辑电路中，某个输入变量通过两条或两条以上的途径传到输出端，由于每条途径的延迟时间不同，到达输出门的时间就有先有后，这种现象称为竞争。把不会产生错误输出的竞争的现象称为非临界竞争。把产生暂时性的或永久性错误输出的竞争现象称为临界竞争 一个竞争的例子如图所示。图中的输入信号经过了两个不同">
<meta property="og:locale">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/2e5f815c7b504cf69353e089b5b8d7d6-16659979117643.png">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/868220a1f57d4e2a8fb83b65e023c6ab.png">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/image-20221017200837328.png">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/图片1-16770680558921.png">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/图片3-16770735254545.png">
<meta property="og:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/image-20221018094610035.png">
<meta property="article:published_time" content="2023-04-08T15:31:20.519Z">
<meta property="article:modified_time" content="2023-04-08T15:42:07.451Z">
<meta property="article:author" content="自是水长东">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/All%20Documents/Markdown/MD杂项/MD.IMG/2e5f815c7b504cf69353e089b5b8d7d6-16659979117643.png">

<link rel="canonical" href="http://example.com/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.3.1%20Race%20Conditions/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Race Condition | 寄尘's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>



<body itemscope itemtype="http://schema.org/WebPage">

<!-- <script src="/live2d/autoload.js"></script> --> <!-- 这条语句和live2d看板娘有关，去掉注释获得看板娘 -->

  <div class="container use-motion">
    <div class="headband"></div>

    <a target="_blank" rel="noopener" href="https://github.com/jichen2002" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">寄尘's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">人生寄一世，奄忽若飙尘</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.3.1%20Race%20Conditions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="自是水长东">
      <meta itemprop="description" content="Medicine, law, business, engineering: these are noble pursuits and necessary to sustain life. But poetry, beauty, romance, love... these are what we stay alive for.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="寄尘's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Race Condition
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-04-08 23:31:20 / 修改时间：23:42:07" itemprop="dateCreated datePublished" datetime="2023-04-08T23:31:20+08:00">2023-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="race-condition">Race Condition</h1>
<p><strong>数字电路中的竞争与冒险</strong></p>
<p><strong>竞争：</strong></p>
<p>竞争（Competition）定义为：在组合逻辑电路中，某个输入变量通过两条或两条以上的途径传到输出端，由于每条途径的延迟时间不同，到达输出门的时间就有先有后，这种现象称为竞争。把不会产生错误输出的竞争的现象称为非临界竞争。把产生暂时性的或永久性错误输出的竞争现象称为临界竞争</p>
<p>一个竞争的例子如图所示。图中的输入信号经过了两个不同的路径，因为处理及布线延时的缘故，不同路径的有效输出信号（对应路径
<span class="math inline">\(1\)</span> 命名为输出 <span
class="math inline">\(1\)</span>，对应路径 <span
class="math inline">\(2\)</span> 命名为输出 <span
class="math inline">\(2\)</span>。图中假设两个输出的理论输出都是从
“<span class="math inline">\(0\)</span>” 到 “<span
class="math inline">\(1\)</span>” 的变化）的时间可能是不同的</p>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\2e5f815c7b504cf69353e089b5b8d7d6-16659979117643.png" alt="2e5f815c7b504cf69353e089b5b8d7d6" style="zoom:80%;" /></p>
<p><strong>冒险：</strong></p>
<p>冒险（Risk）定义为：信号在器件内部通过连线和逻辑单元时，都有一定的延时，延时的大小与连线的长短和逻辑单元的数目有关，同时还受器件的制造工艺、工作电压、温度等条件的影响。信号的高低电平转换也需要一定的过渡时间。由于存在这两方面因素，多路信号的电平值发生变化时，在信号变化的瞬间，组合逻辑的输出有先后顺序，并不是同时变化，往往会出现一些不正确的尖峰信号，这些尖峰信号称为<strong>毛刺</strong>。如果个组合逻辑电路中有‘毛刺’出现，就说明该电路存在冒险</p>
<p>图中的两个输入信号，经过了两个不同的路径，因为处理及布线延时的缘故，对于器件的有效输入信号的时间可能是不同的。器件进行处理获得的输出（假设理论上的输出应该保持
“<span class="math inline">\(0\)</span>”
不变）产生了预料之外的、急风暴雨般的 “<span
class="math inline">\(1\)</span>”。这个短时的高电平就是所谓的毛刺</p>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\868220a1f57d4e2a8fb83b65e023c6ab.png" alt="868220a1f57d4e2a8fb83b65e023c6ab" style="zoom:80%;" /></p>
<h2 id="parallel-computing">Parallel Computing</h2>
<h3 id="并行计算">并行计算</h3>
<p>比数字电路更高层的竞争：并行计算</p>
<ul>
<li><p>多任务处理</p>
<p>现代操作系统多支持多任务处理（无论 CPU 是单核还是多核；无论是多个 CPU
还是单个 CPU）</p></li>
<li><p>多线程</p>
<ul>
<li><p>一个任务可以被拆分成多个小任务并行地处理</p></li>
<li><p>与多进程区别：</p>
<p>资源共享：内存（每个线程有自己的栈，但堆是共享的）、文件描述符等，因此能比多进程有更小的开销</p></li>
<li><p>单核 CPU 还有必要使用多线程吗？</p>
<p>取决于业务需求，如在线听歌软件至少有两个任务：下载和播放，若使用单线程则必须等待下载完才能播放，此时用户体验很差</p></li>
</ul></li>
<li><p>SIMT (Single Instruction Multiple Thread)</p>
<p>GPU 使用的并行计算方式</p></li>
</ul>
<h3 id="调度">调度</h3>
<p><strong>抢占式</strong></p>
<ul>
<li>优点：
<ul>
<li>低延迟（任务第一次被执行时间短）</li>
<li>公平</li>
</ul></li>
<li>缺点：
<ul>
<li>高开销（时钟中断时的处理）</li>
<li>复杂的调度逻辑</li>
</ul></li>
</ul>
<p><strong>协作式</strong></p>
<h2 id="race-condition-1">Race Condition</h2>
<h3 id="java-case">Java Case</h3>
<p>当 <code>balance</code> 值为 <span class="math inline">\(0\)</span>
时，存在两个线程同时运行 <code>adjustBalance()</code>
函数时会发生什么情况？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankAccount</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BankAccount</span><span class="params">(<span class="keyword">int</span> initialBalance)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(initialBalance &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span></span><br><span class="line">                    IllegalArgumentException(<span class="string">&quot;initial balance must be &gt;= 0&quot;</span>);</span><br><span class="line">        balance = initialBalance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustBalance</span><span class="params">(<span class="keyword">int</span> adjustment)</span></span>&#123;</span><br><span class="line">        balance = balance + adjustment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JVM 为基于堆栈实现，对于 Java
语句：<code>balance = balance + adjustment</code>，Java 字节码（byte
code）如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustBalance</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">  Code:</span><br><span class="line">     <span class="number">0</span>: aload_0        <span class="comment">// push address of this object</span></span><br><span class="line">     <span class="number">1</span>: aload_0        <span class="comment">// and again</span></span><br><span class="line">     <span class="number">2</span>: getfield  #<span class="number">14</span>  <span class="comment">// fetch field balance</span></span><br><span class="line">     <span class="number">5</span>: iload_1        <span class="comment">// first argument:adjustment</span></span><br><span class="line">     <span class="number">6</span>: iadd           <span class="comment">// top of stack this.balance adjustment</span></span><br><span class="line">     <span class="number">7</span>: putfield  #<span class="number">14</span>  <span class="comment">// store in field balance</span></span><br><span class="line">    <span class="number">10</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<p>其中使用到的字节码功能如下：</p>
<ul>
<li><code>aload_n</code>：将局部变量表中下标为 <span
class="math inline">\(n\)</span> 的引用数据类型变量压入操作数栈中</li>
<li><code>getfiled #n</code>：将栈顶的对象引用出栈，并取出该对象的字段（或成员变量，此处为
<code>balance</code>）送入栈中，<span class="math inline">\(n\)</span>
表示该字段名称在 <code>.class</code> 常量池中的位置</li>
<li><code>iload_n</code>：从局部变量表中取出编号为 <span
class="math inline">\(n\)</span> 的局部变量送入栈中</li>
<li><code>iadd</code>：取出栈顶的两个数据相加后送回栈中</li>
<li><code>putfield #n</code>：先后将栈顶的数据，对象引用出栈，将数据存储给对象的某个字段，<span
class="math inline">\(n\)</span> 表示该字段名称在 <code>.class</code>
常量池中的位置</li>
<li><code>return</code>：返回</li>
</ul>
<p>用一段伪代码表示就是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp = balance;</span><br><span class="line">temp = temp + adjustment;</span><br><span class="line">balance = temp</span><br></pre></td></tr></table></figure>
<p>假设 <code>balance</code> 初始值为 <span
class="math inline">\(3\)</span>，并且有两个线程会分别执行
<code>adjustBalance(5), adjustBalance(6)</code>，那么显然执行完毕后
<code>balance</code> 的值可能是：<span class="math inline">\(8, 9,
14\)</span></p>
<p><strong>但是，会有可能存在无中生有吗？</strong></p>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\image-20221017200837328.png" alt="image-20221017200837328" style="zoom:80%;" /></p>
<p>假设初始值为 <span class="math inline">\(0\)</span>，那么
<code>x</code> 的值可能为 <span class="math inline">\(42\)</span></p>
<p>问题是，为什么编译器会添加一个 <span
class="math inline">\(42\)</span> 的值到代码中呢？</p>
<p>假设源代码为如下情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">y = stat1(...);</span><br><span class="line">z = stat2(y);</span><br></pre></td></tr></table></figure>
<p>假如编译器认为 <code>stat1(...)</code>
的执行时间将很长，那么编译器可能对其进行优化：先行预测
<code>stat1(...)</code> 的值，如预测为 <span
class="math inline">\(42\)</span>。此时将打破 <code>y, z</code>
变量之间的数据依赖，这就为 CPU 并行执行
<code>stat1(...), stat2(y)</code> 创造了可能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">y = <span class="number">42</span>;</span><br><span class="line">r1 = stat1(…);</span><br><span class="line"><span class="keyword">if</span> r1 != <span class="number">42</span>    <span class="comment">// Given high chances are stat1() = 42</span></span><br><span class="line">    y = r1;</span><br><span class="line">r2 = stat2(y);</span><br></pre></td></tr></table></figure>
<p>假设在多次执行后 CPU 认为如上 <code>if</code> 分支大概率不执行，则
CPU 就会对 <code>stat1(...), stat2(y)</code>
进行并行执行，因此可能导致无中生有的出现</p>
<h4 id="defense---adding-locks">Defense - Adding Locks</h4>
<h3 id="consequence-of-race">Consequence of Race</h3>
<p><strong>竞争冒险经常发生吗？</strong></p>
<ul>
<li>通常而言，竞争很少会发生（因为一般而言会导致竞争的代码很短，CPU
很快就能执行完毕，因此概率很小）。并且即使它发生了，通常也只是导致数据错误</li>
<li>但对于攻击者，攻击者可以利用 fengshui
等手段使一个小概率事件以较大概率发生，并且导致一个不局限于数据错误的结果</li>
</ul>
<p><strong>可能的结果</strong></p>
<ul>
<li>TOCTTOU</li>
<li>Dirty COW</li>
</ul>
<h4 id="tocttou">TOCTTOU</h4>
<p>TOCTTOU（time of check and the time of
use）：即代码先检查某个前置条件（例如认证），然后基于这个前置条件进行某项操作，但是在检查和操作的时间间隔内条件却可能被改变，如果代码的操作与安全相关，那么就很可能产生漏洞。这种安全问题就被称做
TOCTTOU</p>
<p>lpr -r</p>
<p>在以前的 Unix 系统中</p>
<p>mkdir</p>
<p><strong>参考资料：</strong><a
target="_blank" rel="noopener" href="https://blog.csdn.net/u013178472/article/details/112302791">关于TOCTTOU攻击的简介_hututu_404的博客-CSDN博客_toc
tou</a></p>
<h4 id="defense">Defense</h4>
<ul>
<li><p>Using fd instead of pathname</p>
<p>使用路径名：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stat(<span class="string">&quot;/tmp/bob&quot;</span>, &amp;sb);</span><br><span class="line">...</span><br><span class="line">stat(<span class="string">&quot;/tmp/bob&quot;</span>, &amp;sb);</span><br></pre></td></tr></table></figure>
<p>使用文件描述符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/tmp/bob&quot;</span>, O_RDWR);</span><br><span class="line">fstat(fd, &amp;sb);</span><br><span class="line">...</span><br><span class="line">fstat(fd, &amp;sb);</span><br></pre></td></tr></table></figure>
<p>可知用文件名来表示文件是会存在多义性的，每次用相同文件名处理的文件不一定相同；而一个进程持有的文件描述符能够唯一地指向一个文件，该进程对这个文件的处理都会执行到文件描述符所指向的文件</p></li>
<li><p>Using APIs that combine <strong>test-and-get</strong></p></li>
<li><p>Using Locks</p>
<ul>
<li><p>在 Java 中，锁是通过 <code>synchronized</code>
语句来实现的，设有如下一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedTest</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String myName <span class="string">&quot;Jimoer&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (myName)&#123;</span><br><span class="line">            System.out.println(myName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *synchronized使川在静态方法上</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System,out.println(<span class="string">&quot;I am testl method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其 Bytecode 为：</p>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\图片1-16770680558921.png" alt="图片1" style="zoom: 33%;" /></p>
<p>其中 <code>monitorenter</code> 和 <code>moniterexit</code>
可以看作是申请锁和释放锁，但注意到在该段 Bytecode 中只有一个
<code>monitorenter</code>，却有两个 <code>moniterexit</code>。并且第
<span class="math inline">\(17\)</span> 行的 <code>goto</code>
好像保证了第二个 <code>moniterexit</code> 永远不会被触发。实际上这是为了
Java 的 catch error 机制所增加的</p>
<p>注意到该段 Bytecode 下方的 Exception table，其表示从 from 行到 to
行如果出现错误，就跳转到 target 行去处理。因此可以注意到 Exception table
的第一行：从第 <span class="math inline">\(6\)</span> 行到第 <span
class="math inline">\(17\)</span> 行出现的错误都会跳转到第 <span
class="math inline">\(20\)</span> 行去执行，这恰好是在
<code>goto 25</code> 的后一句 Bytecode。故第二个
<code>moniterexit</code> 实际上是为了保证 Java
在进行错误处理时能够把申请的锁释放掉，保证其它线程不因为一个线程的错误而永远拿不到锁导致了无法执行下去</p></li>
<li><p>在 C/C++ 中锁的实现：</p>
<p>Lock variable</p>
<p>Bool type: <span class="math inline">\(0\)</span> for unlocked, <span
class="math inline">\(1\)</span> for locked</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Lock:</span><br><span class="line">mov eax, 1</span><br><span class="line">Loop:</span><br><span class="line">xchg eax [locked]                       # xchg: atomic exchange</span><br><span class="line">test eax eax</span><br><span class="line">jnz Loop</span><br></pre></td></tr></table></figure>
<p>在 C/C++ 中锁的实现依赖于原子的指令 <code>xchg</code></p></li>
</ul></li>
</ul>
<h2 id="instruction-atomicity">Instruction Atomicity</h2>
<ul>
<li>How CPU makes sure the instruction is atomic?
<ul>
<li>CPU cores run coherence protocol. E.g., MESI 缓存一致性协议</li>
<li>To make sure that all core keep the same value for the same cache
line.</li>
<li>At one time, only one core (M or E state) can modify a cache
line.</li>
</ul></li>
<li>All cores maintain a state machine</li>
</ul>
<p>Cacheline Lock 就是通过 MESI 协议实现的，而 <code>xchg</code>
等原子指令则依赖于 Cacheline Lock，因此 MESI 对于原子指令十分重要</p>
<p>MESI 分别表示 Cacheline 的四种状态：</p>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 45%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">状态</th>
<th style="text-align: center;">描述</th>
<th style="text-align: center;">监听任务</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">M：Modified</td>
<td
style="text-align: center;">该缓存行有效，数据被修改了，和内存中的数据不一致，数据只存在于本缓存行中</td>
<td
style="text-align: center;">缓存行必须时刻监听所有试图读该缓存行相对应的内存的操作，其他缓存须在本缓存行写回内存并将状态置为
E 之后才能操作该缓存行对应的内存数据</td>
</tr>
<tr class="even">
<td style="text-align: center;">E：Exclusive</td>
<td
style="text-align: center;">该缓存行有效，数据和内存中的数据一致，数据只存在于本缓存行中</td>
<td
style="text-align: center;">缓存行必须监听其他缓存读主内存中该缓存行相对应的内存的操作，一旦有这种操作，该缓存行需要变成
S 状态</td>
</tr>
<tr class="odd">
<td style="text-align: center;">S：Shared</td>
<td
style="text-align: center;">该缓存行有效，数据和内存中的数据一致，数据同时存在于其他缓存中</td>
<td
style="text-align: center;">缓存行必须监听其他处理器修改该缓存行相对应的本地缓存行的操作，一旦有这种操作，该缓存行需要变成
I 状态</td>
</tr>
<tr class="even">
<td style="text-align: center;">I：Invalid</td>
<td style="text-align: center;">该缓存行数据无效</td>
<td style="text-align: center;">无</td>
</tr>
</tbody>
</table>
<p><strong>参考资料：</strong><a
target="_blank" rel="noopener" href="https://blog.csdn.net/denglin12315/article/details/122639341">缓存一致性协议(MESI)——缓存加锁协议_denglin12315的博客-CSDN博客</a></p>
<h2 id="intel-tsx">Intel TSX</h2>
<ul>
<li>CPU may not honestly get the lock.</li>
<li>You may ask CPU to use speculative execution.</li>
</ul>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\图片3-16770735254545.png" alt="图片3" style="zoom: 67%;" /></p>
<p>即 CPU 在遇到无法拿到锁的情况时可能继续执行临界区代码，但可能中途
abort：</p>
<ul>
<li>数据冲突，即内存等发生了更新</li>
<li>硬件（hardware，HW）资源受限，此时必然将硬件资源让给合法进行的指令</li>
<li>出现 bug 或执行错误</li>
</ul>
<p>此时，</p>
<ul>
<li>一旦 aborted 就返回重新尝试执行</li>
<li>若执行完后锁还是被占用则重新执行</li>
<li>若多次尝试不成功则全力竞争锁</li>
</ul>
<h2 id="linux">Linux</h2>
<h3 id="setuid">setuid</h3>
<h4 id="ruid-和-euid">ruid 和 euid</h4>
<ul>
<li>ruid（real user ID）：即当前执行该文件/程序的用户</li>
<li>euid（effective user ID）：当进程执行时，操作系统会对 euid
进行识别，以此来判断到底用什么权限来执行这个进程。即操作系统实际上是通过判断进程的
euid 而非 ruid 来给予权限的</li>
</ul>
<p>而 setuid 就是类 Unix
系统提供的一个标志位，其实际意义为设置一个进程的 euid
为这个可执行文件或程序的拥有者（如 root）的 uid。即当 setuid
位被设置之后，当文件或程序被执行时，操作系统会赋予进程<strong>文件所有者的权限</strong></p>
<p><strong>注意：</strong>ruid，euid，setuid
都是对文件的可执行权限而言的。即 setuid
并不会对读写权限生效，即使将某文件的 euid
设置为所有者权限也不会改变其它用户在为获取权限的情况下对其的读写权限</p>
<h4 id="文件权限">文件权限</h4>
<p>在命令行窗口下输入 <code>ls -l</code>
命令可以看到文件夹下文件的各种信息，如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drwxr-xr-x 2 root      root      4096 10月 18 09:14 assd</span><br></pre></td></tr></table></figure>
<p>其中前十个字符表示的是文件类型和权限：</p>
<p><img src="D:\All Documents\Markdown\MD杂项\MD.IMG\image-20221018094610035.png" alt="image-20221018094610035" style="zoom:80%;" /></p>
<p>其中，</p>
<ul>
<li>文件类型：<code>d</code> 表示文件夹（directory）；<code>l</code>
表示软链接文件（symlink）；<code>-</code> 表示普通文件</li>
<li>权限：<code>r</code> 表示读权限；<code>w</code>
表示写权限；<code>x</code> 表示执行权限。除此之外还可能存在
<code>s, S</code> 标志，其与 setuid 位有关</li>
</ul>
<h4 id="setuid-与-chmod">setuid 与 chmod</h4>
<p>setuid 的方法是使用 Linux 的 <code>chmod</code>
指令，我们都习惯给予一个文件类似 “<span
class="math inline">\(0750\)</span>” “<span
class="math inline">\(0644\)</span>” 之类的权限，它们的最高位 <span
class="math inline">\(0\)</span> 就是 setuid 的位置,
我们可以通过将其设为 <span class="math inline">\(4\)</span> 来设置
setuid 位（设置为 <span class="math inline">\(2\)</span> 为 setgid，同
setuid 类似，即赋予文件所在组的权限）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 4750 filename</span><br></pre></td></tr></table></figure>
<p>这个命令执行之后再次通过 <code>ls -l</code>
命令查看文件可以发现文件的所属者权限的 <code>x</code> 位变为了
<code>s</code>，这就说明 setuid 权限已经被设置， 之后任何 user
执行这个文件时（user 需要有文件的执行权限）， 都会以 root
的权限运行（假设此文件的所属者为 root）。 所以，针对一个需要被很多 user
以 root 权限执行的文件， 我们可以通过 setuid 来进行操作，
这样就不必为所有 user 都添加 <code>sudo</code> 命令</p>
<p>而 <code>S</code>
标志是当所属者权限无可执行权限时出现的，即当所属者可执行权限为
<code>-</code> 时，再使用 setuid 方法就会使 <code>-</code> 变为
<code>S</code>， 这说明setuid位没有被设置成功</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>自是水长东
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.3.1%20Race%20Conditions/" title="Race Condition">http://example.com/2023/04/08/信息系统安全/Chap.3.1 Race Conditions/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.2%20Heap%20Overflow/" rel="prev" title="Heap Overflow">
      <i class="fa fa-chevron-left"></i> Heap Overflow
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/04/08/%E4%BF%A1%E6%81%AF%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Chap.3.2%20Input%20Problem/" rel="next" title="Input Problem">
      Input Problem <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#race-condition"><span class="nav-number">1.</span> <span class="nav-text">Race Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#parallel-computing"><span class="nav-number">1.1.</span> <span class="nav-text">Parallel Computing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E8%A1%8C%E8%AE%A1%E7%AE%97"><span class="nav-number">1.1.1.</span> <span class="nav-text">并行计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6"><span class="nav-number">1.1.2.</span> <span class="nav-text">调度</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#race-condition-1"><span class="nav-number">1.2.</span> <span class="nav-text">Race Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java-case"><span class="nav-number">1.2.1.</span> <span class="nav-text">Java Case</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#defense---adding-locks"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">Defense - Adding Locks</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#consequence-of-race"><span class="nav-number">1.2.2.</span> <span class="nav-text">Consequence of Race</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tocttou"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">TOCTTOU</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#defense"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">Defense</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#instruction-atomicity"><span class="nav-number">1.3.</span> <span class="nav-text">Instruction Atomicity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#intel-tsx"><span class="nav-number">1.4.</span> <span class="nav-text">Intel TSX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linux"><span class="nav-number">1.5.</span> <span class="nav-text">Linux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setuid"><span class="nav-number">1.5.1.</span> <span class="nav-text">setuid</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ruid-%E5%92%8C-euid"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">ruid 和 euid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">文件权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setuid-%E4%B8%8E-chmod"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">setuid 与 chmod</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="自是水长东"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">自是水长东</p>
  <div class="site-description" itemprop="description">Medicine, law, business, engineering: these are noble pursuits and necessary to sustain life. But poetry, beauty, romance, love... these are what we stay alive for.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=27483202&auto=1&height=66"></iframe>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<!-- 访客数和访问量的设置 -->
<div class="busuanzi-count">
  <script async="" src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js";></script>

  <span class="site-uv">
  <i class="fa fa-user"> 本站访客数</i>
  <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
  人
  </span>

  <span class="site-pv">
  <i class="fa fa-eye"> 本站总访问量</i>
  <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
  次
  </span>

</div>

 <!-- 网站运行时间的设置 -->
    <span id="timeDate">载入天数...</span>
    <span id="times">载入时分秒...</span>  Sometimes your whole life boils down to one insane move.
    <script>
        var now = new Date();
        function createtime() {
            var grt= new Date("09/01/2021 00:00:00");//此处修改你的建站时间或者网站上线时间
            now.setTime(now.getTime()+250);
            days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
            hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
            if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
            mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
            seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
            snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
            document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
            document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
    setInterval("createtime()",250);
    </script><script color="255,105,180" 
 opacity="0.5" 
 zIndex="-1" 
 count="150" 
 src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js">
 </script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

</body>
</html>
